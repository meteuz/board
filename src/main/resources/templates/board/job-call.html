<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="css">
    <link rel="stylesheet" media="screen, print" th:href="@{/css/job-call.css}">
</th:block>

<!-- section start -->
<section layout:fragment="content" th:class="${season}">
    <div class="contents container-fluid"
         th:with="jobCallConst = ${T(com.vdc.board.common.enums.JobCallConst).values()}">
        <div class="row r1">
            <div class="col-xs-2 subject w2"
                 th:style="${'background-color: ' + season.getColor() + ';'}"
                 th:text="'구 분'">

            </div>
            <div class="col-xs-2" th:each="value : ${jobCallConst}">
                <div th:style="${'background-color: ' + season.getColor() + ';'}"
                     th:class="'subject col_title'"
                     th:text="${value.getColTitle()}"></div>
            </div>
        </div>

        <div class="row r2" th:each="jobCallRecordConst : ${T(com.vdc.board.common.enums.JobCallRecordConst).values()}">
            <div th:style="${jobCallRecordConstStat.index > 0 ? 'background-color: ' + season.getColor() + ';' : ''}"
                 th:class="${'col-xs-2 subject w' + jobCallRecordConst.getRecTitle().replace(' ', '').length}"
                 th:classappend="${jobCallRecordConstStat.index == 0 ? season.toString() + '_all' : ''}"
                 th:text="${jobCallRecordConst.getRecTitle()}"></div>
            <div class="col-xs-2"
                 th:each="value : ${jobCallConst}">
                <th:block th:switch="${value.getKey()}">
                    <div th:case="AnswerRate" class="value threshold"
                         th:id="${value.getKey() + '_' + jobCallRecordConstStat.index}">0.00%
                    </div>
                    <div th:case="ServiceLevel" class="value"
                         th:id="${value.getKey() + '_' + jobCallRecordConstStat.index}">0.00%
                    </div>
                    <div th:case="*" class="value" th:id="${value.getKey() + '_' + jobCallRecordConstStat.index}">0
                    </div>
                </th:block>
            </div>
        </div>
    </div>
</section>
<!-- section end -->

<th:block layout:fragment="script">
    <script type="text/javascript" th:inline="javascript">

        /*<![CDATA[*/
        let dept = /*[[ ${dept} ]]*/;
        /*]]*/

        /*<![CDATA[*/
        let wc = /*[[ ${wc} ]]*/;
        /*]]*/

        /*<![CDATA[*/
        let ar = /*[[ ${ar} ]]*/;
        /*]]*/

        $(function () {
            (function poll() {
                $.ajax({
                    url: CONTEXT_PATH + '/getJobCall',
                    method: 'GET',
                    data: {"dept": dept},
                    cache: false,
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        if (data.data.length == 0) {
                            console.log('data length is 0');
                            for (let i = 0; i < 6; i++) {
                                $('#Received_' + i).text('0');
                                $('#Answered_' + i).text('0');
                                $('#Abandoned_' + i).text('0');
                                $('#AnswerRate_' + i).text('0.00%');
                                $('#AnswerRate_' + i).addClass('threshold');
                                $('#ServiceLevel_' + i).text('0.00%');
                            }
                        } else {
                            let num = 0;
                            data.data.forEach(element => {
                                for (const elementKey in element) {
                                    // console.log(elementKey + '_' + num + ':' + element[elementKey]);
                                    num = element['Dash_Div'];

                                    // AnswerRate:36.1% | WaitCalls:27
                                    if (elementKey == 'AnswerRate') {
                                        $('#' + elementKey + '_' + num).removeClass('threshold');

                                        let ar_value;
                                        if (element[elementKey].indexOf('.') > -1) {
                                            ar_value = element[elementKey].split('.')[0];
                                        } else {
                                            ar_value = element[elementKey].replace('%', '');
                                        }

                                        if (ar > Number(ar_value)) {
                                            $('#' + elementKey + '_' + num).addClass('threshold');
                                        }
                                        // console.log(`ar = ${ar} | ${element[elementKey]}`);
                                    }

                                    $('#' + elementKey + '_' + num).text(element[elementKey]);
                                }
                                // num++;
                            });
                        }
                    },
                    timeout: 3000,
                    complete: timeout = setTimeout(function () {
                        poll();
                    }, 5000)

                })
            })();

        });

    </script>
</th:block>

</html>
